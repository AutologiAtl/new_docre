{% extends 'base.html' %}

{% block content %}

{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'css/style2.css' %}">
<style>
    td {
        border: 1px solid #000;
        white-space: nowrap;
    }

    .block-datatext {
        height: 25px;
        background-color: #f2f2f2;
    }

    .container1 {
        border: 2px solid #928f8f;
        white-space: nowrap;
    }
    .sub-btn{
        z-index: 1;
    }
</style>

<body>
    <div>
        <h5
            style="color: #3498db; font-family: 'Arial', sans-serif; font-weight: bold; text-align: center; text-transform: uppercase; margin-top: 2%;">
            Masho Extraction
        </h5>
    </div>
    <div class="main-container clearfix">
        <div class="image-column">
            <div class="arrow-icon left" onclick="showPrevious()">&#9665;</div>
            <img id="current-photo" src='{% static "images/page_3.png" %}' alt="Your Image Description">
            <div class="arrow-icon right" onclick="showNext()">&#9655;</div>
        </div>
        <div class="table-responsive">
            <div class="pr-column" id="image-count"></div>
        </div>
        <!-- Add more pr-columns as needed -->
    </div>
    <div id="image-index"></div>

    <script>
        // Array of photo URLs and data entries
        const photos = [

            '{% static "images/page_3.png" %}',
            '{% static "images/page_4.png" %}',
            '{% static "images/page_5.png" %}',
            '{% static "images/page_6.png" %}',
            '{% static "images/page_7.png" %}',

            // Add more photo URLs as needed
        ];

        const data = '{{ df1_html | safe }}';
        // console.log("data",data)
        const cleanData = data.replace(/[\u0000-\u001F\u007F-\u009F]/g, ''); // Remove all control characters
        // console.log("cleanData", cleanData);
        const escapedData = cleanData.replace(/\\/g, '\\\\'); // Escape backslashes
        // console.log("escapedData", escapedData);
        const parsedData = JSON.parse(escapedData);
        console.log("parsedData", parsedData)

        let currentPhotoIndex = 0;
        const currentPhotoElement = document.getElementById('current-photo');
        const prColumnElement = document.getElementById('image-count');
        const imageIndexElement = document.getElementById('image-index');

        function showPrevious() {
            currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
            updateCurrentPhoto();
        }

        function showNext() {
            currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
            updateCurrentPhoto();
        }

        function updateCurrentPhoto() {
            currentPhotoElement.src = photos[currentPhotoIndex];
            const currentData = parsedData[currentPhotoIndex];
            const currentDataKeys = Object.keys(currentData);
            const currentDataValues = currentData[currentDataKeys];
            console.log("currentData", currentData)
            console.log("currentDataValues", currentDataValues)

            let tableHTML = '<table id="table1" class="table table-bordered table-light"><thead class="thead-light"></thead><tbody>';

            for (const [key, value] of Object.entries(currentDataValues)) {
                tableHTML += `<tr><td>${key}</td><td><input type="text" value="${value !== null ? value : ''}" oninput="updateValue('${key}', this.value)"></td></tr>`;
            }

            tableHTML += '</tbody></table>';
            prColumnElement.innerHTML = tableHTML;


            /// Update image index
            const imageIndexText = `< Masho ${currentPhotoIndex + 1} of ${photos.length} >`;
            imageIndexElement.innerText = imageIndexText;
        }


        function updateValue(key, newValue) {
            parsedData[currentPhotoIndex][currentDataKeys[0]][key] = newValue;
        }
        // Initial update
        updateCurrentPhoto();
    </script>

    <hr>
    <!--  ICM Output -->
    <div class="row">
        <h5
            style="color: #3498db; margin-top: 1%; font-family: 'Arial', sans-serif; font-weight: bold; text-align: center; text-transform: uppercase;">
            SERVICE INSTRUCTION
        </h5>
    </div>

    <div class="container1" style="display: flex;">

        <!-- Column 1: Display PDF -->
        <div style="flex: 1;">
            {% with encoded_file_name=context.media_file_path|urlencode %}

            <embed src="{{ MEDIA_URL }}uploads/{{ encoded_file_name|safe }}" type="application/pdf" width="100%"
                height="600px">

            </embed>

            {% endwith %}
        </div>

        <!-- Column 2: Display Table -->
        <div style="flex: 1;">
            <div id="df2" class="table-responsive" style="overflow-y: auto; margin-top: 5px;">
                <table id="table2" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 30%;">Label</th>
                            <th scope="col" style="width: 70%;">Content</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in df2_html %}
                        <tr style="border: 1px solid #ddd; padding: 2px;">
                            {% for k, v in i.items %}
                            {% if k == 'Label' %}
                            <td class="form-control" style="font-size: 14px; padding-left: 8px;">{{ v }}</td>
                            {% endif %}
                            {% if k == 'Content' %}
                            <td style="padding: 2px;">
                                <div class="form-group" style="margin-top: 2px;">
                                    {% if v|length > 100 %}
                                    <textarea class="form-control"
                                        style="padding: 2px; font-size: 14px; padding-left: 8px;"
                                        rows="6">{{ v }}</textarea>
                                    {% else %}
                                    <input type="text" class="form-control" value="{{ v }}"
                                        style="padding: 2px; font-size: 14px; padding-left: 8px;">
                                    {% endif %}
                                </div>
                            </td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- <h2>Marine services</h2> -->

    <br>
    <hr>

    <div class="table-responsive">
        <table id="table3" class="table table-light table-striped table-hover ">
            <thead class="thead-light">
                <h5
                    style="color: #3498db; font-family: 'Arial', sans-serif; font-weight: bold; text-align: center; text-transform: uppercase;">
                    Invoice Table Extraction
                </h5>
                <tr>
                    {% for column in columns %}
                    <th scope="col">{{ column }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for i in df3_html %}
                <tr>
                    {% for k, v in i.items %}
                    <td class="block-datatext" style="padding: 2px; font-size: 14px; text-align: center;">
                        {{v}}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            </tbody>
        </table>

    </div>
    <!-- Loader overlay -->
    <div id="loader-overlay">
        <div id="loader">
          <div class="loader-circle"></div>
          <div class="loader-text">
            Creating Docre <br>
            Kindly wait for a while...
          </div>
        </div>
      </div>

    <!-- Submit button -->
    <div id="content" style="margin-bottom: 50px;">
        <button id="saveData" class="btn btn-primary mb-3 mt-3 sub-btn">
            Submit
        </button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <!-- CSS for the loader-overlay -->
    <style>
        /* Loader overlay styles */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
        }

        /* Loader text styles */
        .loader-text {
            font-family: Arial, sans-serif;
            font-size: 20px;
            color: #120303;
            text-align: center;
            margin-top: 10px;
        }

        /* Loader styles */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Show loader when active */
        .loader-active #loader-overlay {
            display: block;
        }
    </style>
    <!-- JavaScript for loader and redirection -->
    <script>
        document.getElementById('saveData').addEventListener('click', function () {
            document.body.classList.add('loader-active');

            // Simulate delay with setTimeout
            setTimeout(function () {
                // Redirect to MscExcelView after delay
                window.location.href = '{% url "MscExcelView" %}';
            }, 3000); // Change 3000 to the desired delay time in milliseconds
        });

    </script>


    <!-- ## Extracting the tables data and making the payload dict to pass an react api  -->
    <script>
        $(document).ready(function () {
            // Declare tableData outside the click handler
            var tableData = {};

            var data_ = [];
            $('#table3 td').each(function () {
                data_.push($(this).text());
            });

            var newArray = $.map(data_, function (value) {
                return value.replace(/[\n\s]/g, '')
            });

            // Intercept the button click event
            $("#saveData").click(function () {
                tableData = {
                    'table1_data': collectTableData('#table1 input'),
                    'table2_data': collectTable2Data(),
                    'table3_data': newArray
                    // Add more tables as needed
                };

                function collectTableData(selector) {
                    // Collect data from the specified input fields within a table
                    var tableData = [];
                    $(selector).each(function () {
                        tableData.push($(this).val());
                    });
                    return tableData;
                }

                function collectTable2Data() {
                    // Collect data from both input and textarea for table2
                    var table2Data = [];
                    $('#table2 tbody tr').each(function () {
                        var label = $(this).find('td:eq(0)').text().trim();
                        var content = $(this).find('td:eq(1) :input').val() || $(this).find('td:eq(1)').text().trim();

                        var rowData = {
                            'label': label,
                            'content': content
                        };

                        table2Data.push(rowData);
                    });
                    return table2Data;
                }

                // >>--------------- Converting the table2Data into the payload ---------------<<
                var table2Data = tableData.table2_data;
                var bookingConformationPayload = {};

                // console.log("tabletodata", table2Data)

                // Define the keys for each column in the desired format
                var keysTable2 = {
                    'Actual Shipper': 'ActualShipper',
                    'Booking Number': 'BookingNumber',
                    'Vessel Number': 'Vessel_no',
                    'Shipping Comp Name': 'Shipping_comp_name',
                    'Voyage Number': 'Voyage_no',
                    'B/L Original': 'B/LOriginal',
                    'Port Of Loading': 'PortOfLoading',
                    'Place Of Delivery': 'PlaceOfDelivery',
                    'Port Of Discharge': 'PortOfDischarge',
                    'Port Of Receipt': 'PortOfReceipt',
                    'FREIGHT': 'Freight',
                    'B/L PLACE OF ISSUE': 'B/LPlaceOfIssue',
                    'SHIPPER': 'shipper',
                    'CONSIGNEE': 'consignee',
                    'NOTIFY': 'notify'
                };

                // Loop through each row of table2_data
                for (var i = 0; i < table2Data.length; i += 1) {
                    var label = table2Data[i].label;
                    var content = table2Data[i].content;

                    // Find the corresponding key for the label
                    var key = keysTable2[label];

                    // If a matching key is found, add the content to the corresponding key in the payload
                    if (key) {
                        bookingConformationPayload[key] = content;
                    }
                }

                // Now 'bookingConformationPayload' contains the desired format
                console.log("Table 2: ", bookingConformationPayload);
                console.log("keysTable2",keysTable2)



                // >>--------------- Converting the table3Data into the payload ---------------<<
                var table3Data = tableData.table3_data;
                // Define the keys for each column
                // var keys = ["S.No.", "Year", "Maker", "Name", "Recno.", "Chassis No.",
                //     "Weight", "Length", "Width", "Height", "MEAS", 'Engine Power'];
                var keys = Array.from(document.getElementById('table3').getElementsByTagName('th'), th => th.textContent);
                // Initialize an array to store the payloads for each row
                var table3Payload = [];

                // Calculate the number of rows based on the number of keys
                var numRows = table3Data.length / keys.length;

                // Loop through each row
                for (var rowIndex = 0; rowIndex < numRows; rowIndex++) {
                    var rowPayload = {};

                    // Loop through each key in the keys array
                    for (var keyIndex = 0; keyIndex < keys.length; keyIndex++) {
                        // Calculate the index in table3Data based on rowIndex and keyIndex
                        var dataIndex = rowIndex * keys.length + keyIndex;

                        // Add the key-value pair to rowPayload
                        rowPayload[keys[keyIndex]] = table3Data[dataIndex];
                    }

                    // Add the transformed entry to the array
                    table3Payload.push(rowPayload);
                }


                // Now 'table3Payload' contains the desired format for each row
                // console.log("table 3=======>>", table3Payload);
                let str = '{{ icm }}';

                // Find the index of "&"
                let index = str.indexOf("&");

                if (index !== -1) {
                    // Extract text to the right of "&"
                    rightText = str.substring(index + 1);
                    rightText = rightText.replace('amp;', '');
                    console.log("Text to the right of '&':", rightText);

                    // Extract text to the left of "&"
                    leftText = str.substring(0, index);
                    console.log("Text to the left of '&':", leftText);
                }


                var words1 = bookingConformationPayload['Shipping_comp_name'];
                var words2 = rightText;
                console.log("words1",words1);
                console.log("words2",words2);

                // Loop through words in the first string
                for (let word1 of words1) {
                    console.log("running",word1)
                    // Check if the word exists in the second string
                    if (words2.includes(word1)) {
                        // If a match is found, return "Yes"
                        bookingConformationPayload['com_id'] = leftText
                        console.log("update",bookingConformationPayload['Shipping_comp_name'])
                    }else{
                        bookingConformationPayload['com_id'] = ""

                    }
                }



                var client = rightText;
                var mediator = '{{ icm1 }}';
                // var shipping_comp_name = '{{shipping_comp_name}}';
                // console.log('shipping_comp_name', shipping_comp_name)

                const payload = {
                    "requestID": "DOCUMENTATIONREQUEST",
                    "requestObject": {

                        "Client_Company": client,
                        "booking_comp_name": mediator,

                        "booking_conformation": bookingConformationPayload,
                        "Invoice": table3Payload,
                        "Masho": parsedData
                    }
                };

                console.log("payload", payload);


                // Send data to the server using AJAX
                $.ajax({
                    type: 'POST',
                    url: 'http://127.0.0.1:8000/update_data/',
                    data: JSON.stringify({ payload: payload }, (key, value) => (typeof value === 'string' ? value.replace(/'/g, '"') : value), 2),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        console.log('Data successfully submitted:', data);
                        console.log('url:', url);
                    },
                    error: function (error) {
                        console.log('Error:', error);
                    }
                });

            });
        });
    </script>


    {% endblock %}